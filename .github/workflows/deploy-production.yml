name: Deploy Outline to Hetzner (Production)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Create .env file from GitHub environment secrets
        run: |
          cat <<EOF > .env
          URL=${{ secrets.OUTLINE_URL }}
          OUTLINE_SECRET_KEY=${{ secrets.OUTLINE_SECRET_KEY }}
          OUTLINE_UTILS_SECRET=${{ secrets.OUTLINE_UTILS_SECRET }}
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          OUTLINE_REDIS_URL=${{ secrets.OUTLINE_REDIS_URL }}
          SMTP_HOST=${{ secrets.SMTP_HOST }}
          SMTP_PORT=${{ secrets.SMTP_PORT }}
          SMTP_USERNAME=${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }}
          SMTP_FROM_EMAIL=${{ secrets.SMTP_FROM_EMAIL }}
          SMTP_SECURE=${{ secrets.SMTP_SECURE }}
          SMTP_REPLY_TO_EMAIL=${{ secrets.SMTP_REPLY_TO_EMAIL }}
          SMTP_ALLOW_SELF_SIGNED=false
          SMTP_IGNORE_TLS=false
          SMTP_REQUIRE_TLS=true
          FORCE_HTTPS=true
          NODE_ENV=production
          DEFAULT_LANGUAGE=en_US
          FILE_STORAGE=local
          FILE_STORAGE_LOCAL_ROOT_DIR=/var/lib/outline/data
          FILE_STORAGE_UPLOAD_MAX_SIZE=262144000
          RATE_LIMITER_ENABLED=true
          RATE_LIMITER_REQUESTS=1000
          RATE_LIMITER_DURATION_WINDOW=60
          ENABLE_UPDATES=true
          DEBUG=http
          LOG_LEVEL=info
          EOF

      - name: Create mailu.env file from GitHub environment secrets
        run: |
          cat <<EOF > mailu.env
          VERSION=2024.06
          TZ=UTC
          DOMAIN=${{ secrets.DOMAIN }}
          HOSTNAMES=${{ secrets.HOSTNAMES }}
          BIND_ADDRESS=0.0.0.0
          SUBNET=172.19.0.0/16
          RELAYNETS=0.0.0.0/0
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          ADMIN=${{ secrets.ADMIN }}
          PASSWORD=${{ secrets.PASSWORD }}
          INITIAL_ACCOUNT=${{ secrets.INITIAL_ACCOUNT }}
          INITIAL_PASSWORD=${{ secrets.INITIAL_PASSWORD }}
          DKIM_SELECTOR=mailu
          PORTS=25,110,143,465,587,993,995
          MESSAGE_SIZE_LIMIT=52428800
          TLS_FLAVOR=letsencrypt
          WELCOME=false
          WEBMAIL=none
          WEB_ADMIN=/admin
          FRONT_ADDRESS=mailu-front
          ADMIN_ADDRESS=mailu-admin
          ANTISPAM_ADDRESS=mailu-antispam
          IMAP_ADDRESS=mailu-imap
          IMAP_PORT=143
          COMPRESSION=none
          ANTIVIRUS=none
          ANTISPAM=rspamd
          FETCHMAIL=none
          AUTH_RATELIMIT=5/minute
          RESOLVER=172.19.0.254
          REDIS_URL=redis://mailu-redis:6379/0
          POSTMASTER=postmaster
          LETSENCRYPT_EMAIL=${{ secrets.LETSENCRYPT_EMAIL }}
          EOF

      - name: Copy files to Hetzner server
        run: |
          sshpass -p "${{ secrets.HETZNER_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.HETZNER_USER }}@${{ secrets.HETZNER_HOST }} '
            # Install rsync if not present (openSUSE uses zypper)
            if ! command -v rsync &> /dev/null; then
              echo "Installing rsync..."
              sudo zypper --non-interactive install rsync
            fi
          '
          
          sshpass -p "${{ secrets.HETZNER_PASSWORD }}" rsync -az --delete --exclude='.git' --include='.env' --include='mailu.env' --include='Caddyfile' --include='docker-compose.yml' --include='redis.conf' -e "ssh -o StrictHostKeyChecking=no" ./ ${{ secrets.HETZNER_USER }}@${{ secrets.HETZNER_HOST }}:${{ secrets.HETZNER_PROJECT_PATH }}

      - name: Deploy on Hetzner server
        run: |
          sshpass -p "${{ secrets.HETZNER_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.HETZNER_USER }}@${{ secrets.HETZNER_HOST }} '
            cd ${{ secrets.HETZNER_PROJECT_PATH }} &&
            docker compose pull &&
            docker compose up -d --build
          '